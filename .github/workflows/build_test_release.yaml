name: Build test release

on:
  pull_request:
    branches:
      - dev

jobs:
  build-test-gcc:
    uses: NWChemEx-CI-test/.github/.github/workflows/build_test_release_tmpl.yaml@master
    with: 
      repo: Utilities
      clang-build: false
      gcc-build: true
      ninja_build: true
      test: true
      integration_test: false
      install: false
      base_image_tag: stable
    secrets: inherit 
    #CMAIZE_GITHUB_TOKEN: ${{ secrets.CMAIZE_GITHUB_TOKEN }}
    #DOCKER_PAT: {{ secrets.DOCKER_PAT }}

  build-test-clang:
    uses: NWChemEx-CI-test/.github/.github/workflows/build_test_release_tmpl.yaml@master
    with:
      repo: Utilities
      clang-build: true
      gcc-build: false
      ninja_build: true
      test: true
      integration_test: false
      install: false
      base_image_tag: stable
    secrets: inherit
  
  merge-pr-to-dev:
    runs-on: ubuntu-latest
    needs: [build-test-gcc, build-test-clang]
    if: always() && (needs.build-test-gcc.result == 'success') && (needs.build-test-clang.result == 'success')
    steps:
      - name: merge pr to dev
        uses: "pascalgn/automerge-action@v0.15.6"
        env:
          GITHUB_TOKEN: "${{ secrets.DOCKER_PAT }}"
          MERGE_LABELS: ""

  integration_test-gcc:
    uses: NWChemEx-CI-test/.github/.github/workflows/build_test_release_tmpl.yaml@master
    needs: merge-pr-to-dev
    if: always() && (needs.merge-pr-to-dev.result == 'success')
    with:
      repo: Utilities
      clang-build: false
      gcc-build: true
      ninja_build: true
      test: true
      integration_test: true
      install: true
      base_image_tag: stable
      ref: dev
    secrets: inherit

  integration_test-clang:
    uses: NWChemEx-CI-test/.github/.github/workflows/build_test_release_tmpl.yaml@master
    needs: merge-pr-to-dev
    if: always() && (needs.merge-pr-to-dev.result == 'success')
    with:
      repo: Utilities
      clang-build: true
      gcc-build: false
      ninja_build: true
      test: true
      integration_test: true
      install: true
      base_image_tag: stable
      ref: dev
    secrets: inherit

